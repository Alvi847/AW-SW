<div class="perfil-card-container">
  <div class="perfil-card">
    <div class="menu-lateral">
      <ul>
        <li>
          <a href="/usuarios/<%= usuario.username %>/recetas"
            >Recetas de <%= usuario.nombre %></a
          >
        </li>
        <li>
          <a href="/usuarios/<%= usuario.username %>/favoritos"
            >Favoritas de <%= usuario.nombre %></a
          >
        </li>
      </ul>
    </div>

    <div class="contenido-perfil">
      <h1 class="titulo-perfil">Perfil de <%= usuario.nombre %></h1>

      <div class="contenido-info">
        <div class="perfil-foto">
          <% if (usuario.imagen) { %>
          <img src="/imagen/<%= usuario.imagen %>" alt="Foto de perfil" />
          <% } else { %>
          <p>Este usuario no tiene foto de perfil.</p>
          <% } %>
        </div>

        <div class="perfil-detalles">
          <h2>Detalles del usuario:</h2>
          <p><strong>Nombre:</strong> <%= usuario.nombre %></p>
          <p><strong>Username:</strong> <%= usuario.username %></p>
          <p><strong>Email:</strong> <%= usuario.email %></p>

          <% if (session.username === usuario.username) { %>
          <div class="botones-perfil">
            <a href="/usuarios/updatePerfil" class="editar">Editar perfil</a>
            <a href="/usuarios/logout" class="logout">Cerrar sesi√≥n</a>
          </div>
          <% } %>
        </div>
      </div>

      <div id="calendar"></div>

      <% if (session.username === usuario.username) { %>
      <div class="crear-evento">
        <h3>üìÖ  A√ëADIR NUEVO EVENTO</h3>
        <form id="formEvento">
          <div class="form-group">
            <label for="titulo">T√≠tulo del evento</label>
            <input type="text" id="titulo" required />
          </div>

          <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" required />
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n</label>
            <textarea
              id="descripcion"
              rows="3"
              placeholder="Escribe una breve descripci√≥n..."
            ></textarea>
          </div>

          <button type="submit" class="btn-enviar">Crear evento</button>
        </form>
      </div>
      <% } %>
    </div>
    <div id="editModal" class="modal hidden">
      <div class="modal-content">
        <h3 class="modal-titulo">‚úèÔ∏èEDITAR EVENTO</h3>
        <form id="editForm">
          <input type="hidden" id="editId" />
    
          <div class="form-group">
            <label for="editTitulo">T√≠tulo</label>
            <input type="text" id="editTitulo" required />
          </div>
    
          <div class="form-group">
            <label for="editFecha">Fecha</label>
            <input type="date" id="editFecha" required />
          </div>
    
          <div class="form-group">
            <label for="editDescripcion">Descripci√≥n</label>
            <textarea id="editDescripcion" rows="3"></textarea>
          </div>
    
          <div class="form-buttons">
            <button type="button" class="btn-cancelar" onclick="document.getElementById('editModal').classList.add('hidden')">Cancelar</button>
            <button type="submit" class="btn-guardar">Guardar</button>
          </div>
        </form>
      </div>
    </div>    

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/locales/es.global.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const calendarEl = document.getElementById("calendar");
    let eventoSeleccionado = null;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "es",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek",
      },
      events: async function (info, successCallback, failureCallback) {
        try {
          const res = await fetch("/eventos/<%= usuario.username %>");
          const data = await res.json();

          const eventos = data.map((e) => ({
            id: e.id,
            title: e.titulo,
            start: e.fecha,
            descripcion: e.descripcion,
          }));

          successCallback(eventos);
        } catch (err) {
          console.error("Error al cargar eventos:", err);
          failureCallback(err);
        }
      },
      eventClick: function (info) {
        const event = info.event;
        eventoSeleccionado = event;

        if (window.activeTippy) window.activeTippy.destroy();

        const content = document.createElement("div");
        content.innerHTML = `
  <div style="padding: 14px 16px; max-width: 300px; font-family: 'Montserrat', sans-serif;">
    <h3 style="margin: 0; font-size: 18px; color: #ffbd3a;">${event.title}</h3>
    <p style="margin: 8px 0 4px; font-size: 14px; color: #ccc;">${event.extendedProps.descripcion || "Sin descripci√≥n"}</p>
    <p style="margin: 0 0 12px; font-size: 13px; color: #888;">üìÖ ${new Date(event.start).toLocaleDateString("es-ES")}</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button id="tippyEditar" class="popup-btn editar">‚úèÔ∏è Editar</button>
      <button id="tippyEliminar" class="popup-btn eliminar">üóëÔ∏è Eliminar</button>
    </div>
  </div>
`;


        const tip = tippy(info.el, {
          content,
          allowHTML: true,
          interactive: true,
          placement: 'right',
          trigger: 'manual',
          appendTo: document.body,
          theme: 'light-border',
          arrow: true,
          onHidden() {
            tip.destroy();
            window.activeTippy = null;
          }
        });

        tip.show();
        window.activeTippy = tip;

        content.querySelector("#tippyEliminar").addEventListener("click", async () => {
          if (confirm("¬øSeguro que quieres eliminar este evento?")) {
            const res = await fetch(`/eventos/${event.id}`, { method: "DELETE" });
            if (res.ok) {
              calendar.refetchEvents();
              tip.hide();
            } else {
              alert("Error al eliminar");
            }
          }
        });

        content.querySelector("#tippyEditar").addEventListener("click", () => {
          document.getElementById("editId").value = event.id;
          document.getElementById("editTitulo").value = event.title;
          document.getElementById("editFecha").value = event.startStr;
          document.getElementById("editDescripcion").value = event.extendedProps.descripcion || "";
          document.getElementById("editModal").classList.remove("hidden");
          tip.hide();
        });
      }
    });

    calendar.render();

    const editForm = document.getElementById("editForm");
    if (editForm) {
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("editId").value;
        const titulo = document.getElementById("editTitulo").value;
        const fecha = document.getElementById("editFecha").value;
        const descripcion = document.getElementById("editDescripcion").value;

        try {
          const res = await fetch(`/eventos/actualizar`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id, titulo, fecha, descripcion }),
          });

          if (res.ok) {
            alert("Evento actualizado");
            calendar.refetchEvents();
            document.getElementById("editModal").classList.add("hidden");
          } else {
            alert("No se pudo actualizar");
          }
        } catch (err) {
          console.error(err);
          alert("Error de red");
        }
      });
    }
  });
</script>

<script>
  document.getElementById("formEvento")?.addEventListener("submit", async function (e) {
    e.preventDefault();

    const titulo = document.getElementById("titulo").value.trim();
    const fecha = document.getElementById("fecha").value;
    const descripcion = document.getElementById("descripcion").value.trim();

    if (!titulo || !fecha) return alert("T√≠tulo y fecha son obligatorios");

    try {
      const res = await fetch("/eventos/crear", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ titulo, fecha, descripcion }),
      });

      if (res.ok) {
        alert("Evento creado correctamente");
        location.reload(); // o calendar.refetchEvents();
      } else {
        alert("Error al crear evento");
      }
    } catch (err) {
      console.error(err);
      alert("Error de red");
    }
  });
</script>
