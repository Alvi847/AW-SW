
<div class="perfil-card-container">
  <div class="perfil-card">
    
    <div class="menu-lateral">
      <ul>
       
        <li><a href="/usuarios/<%= usuario.username %>/recetas">Recetas de <%= usuario.nombre %></a></li>
        <li><a href="/usuarios/<%= usuario.username %>/favoritos">Favoritas de <%= usuario.nombre %></a></li>
      </ul>
    </div>

    <div class="contenido-perfil">
      <h1 class="titulo-perfil">Perfil de <%= usuario.nombre %></h1>

      <div class="contenido-info">
        <div class="perfil-foto">
          <% if (usuario.imagen) { %>
            <img src="/imagen/<%= usuario.imagen %>" alt="Foto de perfil">
          <% } else { %>
            <p>Este usuario no tiene foto de perfil.</p>
          <% } %>
        </div>

        <div class="perfil-detalles">
          <h2>Detalles del usuario:</h2>
          <p><strong>Nombre:</strong> <%= usuario.nombre %></p>
          <p><strong>Username:</strong> <%= usuario.username %></p>
          <p><strong>Email:</strong> <%= usuario.email %></p>

          <% if (session.username === usuario.username) { %>
            <div class="botones-perfil">
              <a href="/usuarios/updatePerfil" class="editar">Editar perfil</a>
              <a href="/usuarios/logout" class="logout">Cerrar sesión</a>
            </div>
          <% } %>
        </div>
        
      </div>
      <div id='calendar'></div>
      <% if (session.username === usuario.username) { %>
        <div class="crear-evento">
          <h3>Añadir evento</h3>
          <form id="formEvento">
            <input type="text" id="titulo" placeholder="Título" required>
            <input type="date" id="fecha" required>
            <textarea id="descripcion" placeholder="Descripción" rows="3"></textarea>
            <button type="submit">Crear evento</button>
          </form>
        </div>
      <% } %>
      
    </div>
  </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/locales/es.global.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', async function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',  // Calendario en español
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek'
      },
      events: async function (info, successCallback, failureCallback) {
        try {
          const res = await fetch('/eventos/<%= usuario.username %>');
          const data = await res.json();

          const eventos = data.map(e => ({
            title: e.titulo,
            start: e.fecha,
            description: e.descripcion
          }));

          successCallback(eventos);
        } catch (err) {
          console.error('Error al cargar eventos:', err);
          failureCallback(err);
        }
      }
    });

    calendar.render();
  });
</script>
<script>
  document.getElementById('formEvento')?.addEventListener('submit', async function (e) {
    e.preventDefault();

    const titulo = document.getElementById('titulo').value.trim();
    const fecha = document.getElementById('fecha').value;
    const descripcion = document.getElementById('descripcion').value.trim();

    if (!titulo || !fecha) return alert("Título y fecha son obligatorios");

    try {
      const res = await fetch('/eventos/crear', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ titulo, fecha, descripcion })
      });

      if (res.ok) {
        alert('Evento creado correctamente');
        location.reload(); // recarga para mostrar el nuevo evento
      } else {
        alert('Error al crear evento');
      }
    } catch (err) {
      console.error(err);
      alert('Error de red');
    }
  });
</script>
